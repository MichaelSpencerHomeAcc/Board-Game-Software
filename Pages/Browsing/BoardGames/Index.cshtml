@page
@model Board_Game_Software.Pages.Browsing.BoardGames.IndexModel
@{
    ViewData["Title"] = "Board Games";
}

<div class="row">
    <div class="col-12">
        <h2>Board Game Search</h2>

        <form method="get" id="searchForm" autocomplete="off">
            <div class="input-group mb-3 position-relative">
                <input id="searchBox" name="search" class="form-control" placeholder="Search by name, type, or player count..." value="@Model.SearchTerm" autocomplete="off" />
                <button class="btn btn-primary" type="submit">Search</button>
                <ul id="autocomplete-results" class="list-group position-absolute w-100 bg-white border rounded" style="z-index: 1000; top: 100%; left: 0; max-height: 300px; overflow-y: auto;"></ul>
            </div>
        </form>

        <div class="d-flex justify-content-between align-items-center mb-3">
            @if (User.IsInRole("Admin"))
            {
                <a asp-page="./Add" class="btn btn-success">+ Add New Board Game</a>
            }
        </div>


        <div id="previewTooltip" style="position:absolute; display:none; border:1px solid #ccc; background:#fff; padding:5px; box-shadow:0 0 5px rgba(0,0,0,0.2); max-width:200px; z-index:2000;">
            <img id="previewImage" src="" alt="Preview" style="max-width: 200px; max-height: 200px;" />
        </div>

        @if (Model.BoardGames.Any())
        {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Players</th>
                        <th>Release Date</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.BoardGames)
                    {
                        <tr>
                            <td>
                                <a asp-page="./BoardGameDetails" asp-route-id="@item.BoardGame.Id"
                                   class="board-game-link"
                                   data-image="@item.Base64Image">
                                    @item.BoardGame.BoardGameName
                                </a>
                            </td>
                            <td>@item.BoardGame.FkBgdBoardGameTypeNavigation?.TypeDesc</td>
                            <td>@item.BoardGame.PlayerCountMin @(item.BoardGame.PlayerCountMax != item.BoardGame.PlayerCountMin ? " – " + item.BoardGame.PlayerCountMax : "")</td>
                            <td>@(item.BoardGame.ReleaseDate?.ToString("yyyy-MM-dd") ?? "-")</td>
                        </tr>
                    }

                </tbody>
            </table>
        }
        else
        {
            <p>No board games found.</p>
        }
    </div>
</div>

@section Scripts {
    <script>
        const input = document.getElementById('searchBox');
        const resultsBox = document.getElementById('autocomplete-results');
        const form = document.getElementById('searchForm');

        input.addEventListener('input', async () => {
            const term = input.value.trim();
            if (term.length < 1) {
                resultsBox.innerHTML = '';
                return;
            }

            try {
                // Fixed URL to point to Browsing/BoardGames for handler=Search
                const res = await fetch(`/Browsing/BoardGames?handler=Search&term=${encodeURIComponent(term)}`);
                const data = await res.json();

                resultsBox.innerHTML = '';
                data.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item list-group-item-action';
                    li.style.cursor = 'pointer';
                    li.innerHTML = `<strong>${item.name}</strong> <small class="text-muted">(${item.type})</small>`;
                    li.onclick = () => {
                        input.value = item.name;
                        resultsBox.innerHTML = '';
                        form.submit();
                    };
                    resultsBox.appendChild(li);
                });
            } catch (err) {
                console.error('Autocomplete fetch failed', err);
            }
        });

        document.addEventListener('click', e => {
            if (!resultsBox.contains(e.target) && e.target !== input) {
                resultsBox.innerHTML = '';
            }
        });

        // Tooltip preview code
        const previewTooltip = document.getElementById('previewTooltip');
        const previewImage = document.getElementById('previewImage');

        document.querySelectorAll('.board-game-link').forEach(link => {
            link.addEventListener('mouseenter', e => {
                const imageUrl = e.target.getAttribute('data-image');
                if (imageUrl) {
                    previewImage.src = imageUrl;
                    previewTooltip.style.display = 'block';
                }
            });

            link.addEventListener('mousemove', e => {
                previewTooltip.style.top = (e.pageY + 15) + 'px';
                previewTooltip.style.left = (e.pageX + 15) + 'px';
            });

            link.addEventListener('mouseleave', () => {
                previewTooltip.style.display = 'none';
                previewImage.src = '';
            });
        });
    </script>
}

