@page "{id:long}"
@model Board_Game_Software.Pages.Browsing.BoardGames.BoardGameDetailsModel
@{
    ViewData["Title"] = Model.BoardGame?.BoardGameName ?? "Board Game Details";
}
@inject Microsoft.AspNetCore.Identity.UserManager<Microsoft.AspNetCore.Identity.IdentityUser> UserManager
@inject Microsoft.AspNetCore.Identity.SignInManager<Microsoft.AspNetCore.Identity.IdentityUser> SignInManager

@{
    var isAdmin = false;
    if (SignInManager.IsSignedIn(User))
    {
        var currentUser = await UserManager.GetUserAsync(User);
        if (currentUser != null)
        {
            isAdmin = await UserManager.IsInRoleAsync(currentUser, "Admin");
        }
    }
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-7">
            <div class="d-flex align-items-center mb-3">
                <h1 class="mb-0">
                    @Model.BoardGame.BoardGameName
                    @if (Model.BoardGame.BoardGameShelfSections != null && Model.BoardGame.BoardGameShelfSections.Any())
                    {
                        var firstShelf = Model.BoardGame.BoardGameShelfSections.FirstOrDefault()?.FkBgdShelfSectionNavigation;
                        if (firstShelf != null)
                        {
                            <span style="color: black; font-weight: 400; font-size: 1em; margin-left: 0.5rem;">
                                - Shelf: @firstShelf.SectionName
                            </span>
                        }
                    }
                </h1>
            </div>

            @if (isAdmin)
            {
                <div class="mb-3">
                    <a asp-page="/Browsing/BoardGames/Edit" asp-route-id="@Model.BoardGame.Id" class="btn btn-primary">Edit</a>
                </div>
            }

            <dl class="row">
                <dt class="col-sm-4 fw-bold">Type</dt>
                <dd class="col-sm-8">@(Model.BoardGame.FkBgdBoardGameTypeNavigation?.TypeDesc ?? "-")</dd>

                <dt class="col-sm-4 fw-bold">Players</dt>
                <dd class="col-sm-8">
                    @Model.BoardGame.PlayerCountMin
                    @(Model.BoardGame.PlayerCountMax != Model.BoardGame.PlayerCountMin ? " – " + Model.BoardGame.PlayerCountMax : "")
                </dd>

                <dt class="col-sm-4 fw-bold">Playing Time</dt>
                <dd class="col-sm-8">
                    @(
                                        Model.BoardGame.PlayingTimeMinInMinutes.HasValue
                                        ? Model.BoardGame.PlayingTimeMinInMinutes.Value + " min"
                                        : "-"
                                        )
                    @if (Model.BoardGame.PlayingTimeMaxInMinutes.HasValue &&
                                        Model.BoardGame.PlayingTimeMaxInMinutes != Model.BoardGame.PlayingTimeMinInMinutes)
                    {
                        <text> – @Model.BoardGame.PlayingTimeMaxInMinutes.Value min</text>
                    }
                </dd>

                <dt class="col-sm-4 fw-bold">Complexity</dt>
                <dd class="col-sm-8">
                    @(Model.BoardGame.ComplexityRating.HasValue
                                        ? Model.BoardGame.ComplexityRating.Value.ToString("0.0")
                                        : "-")
                </dd>

                <dt class="col-sm-4 fw-bold">Victory Condition</dt>
                <dd class="col-sm-8">
                    @(Model.BoardGame.FkBgdBoardGameVictoryConditionTypeNavigation?.TypeDesc ?? "-")
                </dd>

                <dt class="col-sm-4 fw-bold">Publisher</dt>
                <dd class="col-sm-8">
                    @(Model.BoardGame.FkBgdPublisherNavigation?.PublisherName ?? "-")
                </dd>

                <dt class="col-sm-4 fw-bold">Release Date</dt>
                <dd class="col-sm-8">@(Model.BoardGame.ReleaseDate?.ToString("yyyy-MM-dd") ?? "-")</dd>

                <dt class="col-sm-4 fw-bold">Summary</dt>
                <dd class="col-sm-8">@(!string.IsNullOrWhiteSpace(Model.BoardGame.BoardGameSummary) ? Model.BoardGame.BoardGameSummary : "-")</dd>

                <dt class="col-sm-4 fw-bold">Dimensions (cm)</dt>
                <dd class="col-sm-8">
                    @(
                                        Model.BoardGame.HeightCm.HasValue
                                        ? Model.BoardGame.HeightCm.Value.ToString("0.##")
                                        : "-"
                                        )
                    @if (Model.BoardGame.WidthCm.HasValue)
                    {
                        <text> (H) x @Model.BoardGame.WidthCm.Value.ToString("0.##") (W)</text>
                    }
                </dd>

                @if (!string.IsNullOrWhiteSpace(Model.BoardGame.HowToPlayHyperlink) && Model.BoardGame.HowToPlayHyperlink.ToLower() != "null")
                {
                    <dt class="col-sm-4 fw-bold">How to Play</dt>
                    <dd class="col-sm-8">
                        <a href="@Model.BoardGame.HowToPlayHyperlink" target="_blank" rel="noopener noreferrer">Instructions / Video</a>
                    </dd>
                }
            </dl>

            <a asp-page="./Index" class="btn btn-secondary mt-3">Back to List</a>
        </div>

        <div class="col-md-5 d-flex flex-column align-items-center">
            @if (!string.IsNullOrWhiteSpace(Model.BoardGameFrontImageUrl))
            {
                <img src="@Model.BoardGameFrontImageUrl" alt="@Model.BoardGame.BoardGameName"
                     style="max-width: 300px; max-height: 300px; width: auto; height: auto; object-fit: contain; border-radius: 0.25rem; box-shadow: 0 0 15px rgba(0,0,0,0.2);" />
            }
            else
            {
                <div class="border border-secondary rounded d-flex align-items-center justify-content-center"
                     style="width: 300px; height: 300px; color: #999;">
                    No image available
                </div>
            }

            @if (Model.BoardGame.BoardGameMarkers != null && Model.BoardGame.BoardGameMarkers.Any())
            {
                <h3 class="mt-4 text-center">Markers Included</h3>

                <div class="markers-container">
                    @foreach (var marker in Model.BoardGame.BoardGameMarkers.OrderBy(m => m.FkBgdBoardGameMarkerTypeNavigation.TypeDesc))
                    {
                        var markerType = marker.FkBgdBoardGameMarkerTypeNavigation;
                        if (markerType != null)
                        {
                            var imgSrc = Model.MarkerImagesBase64.ContainsKey(markerType.Id)
                            ? Model.MarkerImagesBase64[markerType.Id]
                            : null;

                            <button class="btn btn-outline-secondary marker-btn"
                                    data-img="@imgSrc"
                                    onmouseover="showMarkerImage(event)"
                                    onmouseout="hideMarkerImage()"
                                    style="margin: 3px;">
                                @markerType.TypeDesc
                            </button>
                        }
                    }
                </div>

                <div id="markerImagePreview" style="position:absolute; display:none; border:1px solid #ccc; padding:5px; background:#fff; z-index:1000;">
                    <img id="markerImage" style="max-width:300px; max-height:300px;" />
                </div>
            }
        </div>
    </div>
</div>

<script>
    function showMarkerImage(e) {
        const imgSrc = e.target.getAttribute('data-img');
        const preview = document.getElementById('markerImagePreview');
        const img = document.getElementById('markerImage');

        if (imgSrc) {
            img.src = imgSrc;
            preview.style.display = 'block';
            preview.style.top = (e.pageY + 10) + 'px';
            preview.style.left = (e.pageX + 10) + 'px';
        }
    }

    function hideMarkerImage() {
        const preview = document.getElementById('markerImagePreview');
        preview.style.display = 'none';
        document.getElementById('markerImage').src = '';
    }
</script>

<style>
    dl dt {
        font-weight: 600;
        color: #333;
    }

    dl dd {
        margin-bottom: 1rem;
    }

    .markers-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center; /* centers the buttons horizontally */
        gap: 0.5rem; /* space between buttons */
        max-height: 300px; /* max height for scrolling */
        overflow-y: auto;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #fff;
        width: 100%; /* full width inside col */
        box-sizing: border-box;
    }

        .markers-container button {
            min-width: 90px; /* consistent button width */
        }
</style>
