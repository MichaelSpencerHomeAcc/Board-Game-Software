@page
@model Board_Game_Software.Pages.Match.CreateMatchModel
@using System.Text.Encodings.Web
@{
    ViewData["Title"] = "Record Match";
}

<style>
    .step-content {
        display: none;
    }

        .step-content.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

    @@keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .game-card {
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
        background: #2b2f32;
        border-radius: 12px;
        overflow: hidden;
    }

        .game-card:hover {
            transform: scale(1.05);
            border-color: #0d6efd;
        }

        .game-card img {
            height: 160px;
            width: 100%;
            object-fit: contain;
            background: #1a1d20;
            padding: 5px;
        }

    .player-tile {
        transition: all 0.2s;
        border: 1px solid rgba(255,255,255,0.1);
        background: #2b2f32;
        cursor: pointer;
        border-radius: 12px;
    }

        .player-tile.selected {
            border-color: #0d6efd;
            background: rgba(13,110,253,0.05);
        }

        .player-tile.locked {
            opacity: 0.3;
            filter: grayscale(1);
            pointer-events: none;
        }

    .p-check {
        display: none;
    }

    .player-tile img {
        width: 54px;
        height: 54px;
        object-fit: cover;
        border-radius: 50%;
    }

    .role-badge {
        display: inline-flex;
        align-items: center;
        background: rgba(13,110,253,0.2);
        border: 1px solid #0d6efd;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
    }

    .initials-avatar {
        width: 54px;
        height: 54px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        letter-spacing: 0.5px;
        color: #fff;
        user-select: none;
        flex: 0 0 54px;
    }


    .marker-search-img {
        width: 30px;
        height: 30px;
        object-fit: contain;
        margin-right: 8px;
        border-radius: 4px;
    }

    .marker-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        max-height: 450px;
        overflow-y: auto;
        padding: 5px;
    }

    .marker-option {
        cursor: pointer;
        padding: 12px;
        border: 1px solid #3d4246;
        border-radius: 8px;
        text-align: center;
        transition: 0.2s;
        background: #1a1d20;
    }

        .marker-option:hover:not(.disabled) {
            background: #3d4246;
            border-color: #0d6efd;
        }

        .marker-option img {
            width: 40px;
            height: 40px;
            object-fit: contain;
            margin-bottom: 8px;
        }

        .marker-option.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(1);
        }
</style>

<div class="container py-4">
    <div asp-validation-summary="All" class="text-danger mb-3"></div>

    <form method="post" id="matchForm">
        <input type="hidden" asp-for="Input.NightId" />
        <input type="hidden" asp-for="Input.ReturnUrl" />
        <input type="hidden" asp-for="Input.BoardGameId" id="hiddenGameId" />
        <input type="hidden" asp-for="Input.PlayerMarkersJson" id="markersJson" />

        @* STEP 1 *@
        <div id="step1" class="step-content active text-center">
            <h1 class="display-6 fw-bold mb-3">Step 1: Choose Game</h1>
            <input type="text" id="gameSearchInput" class="form-control mb-5 p-3 rounded-pill bg-dark text-white border-secondary"
                   placeholder="Search library..." style="max-width:400px; margin:0 auto;">

            <div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-4">
                @foreach (var g in Model.Games)
                {
                    var safeName = JavaScriptEncoder.Default.Encode(g.Name);
                    <div class="col game-item" data-name="@g.Name.ToLower()">
                        <div class="card game-card h-100 shadow-sm"
                             onclick="selectGame(@g.Id, '@safeName', '@g.CoverUrl', @(g.MaxPlayers ?? 99))">
                            <img src="@(g.CoverUrl ?? "/images/default-cover.png")"
                                 loading="lazy" decoding="async" />
                            <div class="card-body p-2 text-center">
                                <div class="fw-bold small text-truncate">@g.Name</div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        @* STEP 2 *@
        <div id="step2" class="step-content">
            <div class="d-flex align-items-center mb-5 bg-dark p-3 rounded-4 shadow-sm border border-secondary">
                <img id="displayGameCover" src="" class="rounded me-3 shadow"
                     style="width:80px; height:80px; object-fit:contain; background:#000;"
                     loading="lazy" decoding="async" />
                <div class="flex-grow-1">
                    <h2 class="fw-bold mb-0" id="displayGameName"></h2>
                    <div id="limitDisplay" class="text-info small fw-bold"></div>
                    <button type="button" class="btn btn-sm btn-link p-0 text-decoration-none" onclick="goToStep(1)">Change Game</button>
                </div>
                <div class="ms-auto text-end">
                    <label class="form-label small fw-bold text-uppercase opacity-50">Match Start Time</label>
                    <input asp-for="Input.MatchDate" type="datetime-local" class="form-control form-control-sm" />
                </div>
            </div>

            <h4 class="fw-bold mb-4">Step 2: Assign Players & Roles</h4>
            <div class="row g-3">
                @foreach (var p in Model.Players)
                {
                    <div class="col-md-6">
                        <div class="player-tile p-3 d-flex align-items-center" id="tile_@p.PlayerId" onclick="togglePlayer(@p.PlayerId)">
                            <input type="checkbox" name="Input.SelectedPlayerIds" value="@p.PlayerId" id="chk_@p.PlayerId" class="p-check">
                            <img src="@(p.AvatarUrl ?? "/images/default-avatar.png")" class="me-3"
                                 id="avatar_@p.PlayerId"
                                 loading="lazy" decoding="async"
                                 onerror="makeInitialsAvatar(this, '@p.Name')" />
                            <div class="flex-grow-1 overflow-hidden">
                                <div class="fw-bold text-truncate">@p.Name</div>

                                <div class="marker-assignment-area d-none mt-2" id="marker_area_@p.PlayerId" onclick="event.stopPropagation()">
                                    <div id="selected_role_@p.PlayerId" class="role-badge d-none me-2 mb-1">
                                        <img src="" class="marker-search-img d-none" />
                                        <span class="role-text"></span>
                                        <i class="bi bi-x-circle ms-2 cursor-pointer" onclick="clearMarker(@p.PlayerId)"></i>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary rounded-pill px-3" onclick="openMarkerModal(@p.PlayerId)">Assign Role</button>
                                    <input type="hidden" class="player-marker-value" data-pid="@p.PlayerId" value="" />
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="mt-5 d-flex gap-3 justify-content-center">
                <button type="submit" class="btn btn-primary btn-lg rounded-pill px-5 shadow">Save Match</button>
                <a href="/GameNight/Details/@Model.Input.NightId" class="btn btn-outline-secondary btn-lg rounded-pill px-4">Cancel</a>
            </div>
        </div>
    </form>
</div>

@* MARKER SELECTION MODAL *@
<div class="modal fade" id="markerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark border-secondary text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Select Role</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="markerSearchInput" class="form-control mb-3 bg-transparent border-secondary text-white" placeholder="Filter roles...">
                <div class="marker-grid" id="modalMarkerGrid"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentGameMarkers = [];
        let activePlayerId = null;
        let maxPlayers = 99;

        $('#gameSearchInput').on('keyup', function () {
            const val = $(this).val().toLowerCase();
            $('.game-item').each(function () { $(this).toggle($(this).data('name').includes(val)); });
        });

        function goToStep(s) {
            $('.step-content').removeClass('active');
            $(`#step${s}`).addClass('active');
            window.scrollTo(0, 0);
        }

        async function selectGame(id, name, coverUrl, limit) {
            $('#hiddenGameId').val(id);
            $('#displayGameName').text(name);
            $('#displayGameCover').attr('src', coverUrl || '/images/default-cover.png');

            maxPlayers = limit;
            $('#limitDisplay').text(`Player Limit: ${limit}`);

            $('.p-check').prop('checked', false);
            $('.player-tile').removeClass('selected locked');
            $('.marker-assignment-area').addClass('d-none');
            $('.player-marker-value').val('');
            $('.role-badge').addClass('d-none');

            const res = await fetch(`?handler=Markers&gameId=${id}`);
            currentGameMarkers = await res.json();

            goToStep(2);
        }

        function togglePlayer(id) {
            const chk = $(`#chk_${id}`);
            const tile = $(`#tile_${id}`);
            if (!chk.is(':checked') && $('.p-check:checked').length >= maxPlayers) return;

            chk.prop('checked', !chk.prop('checked'));

            if (chk.is(':checked')) {
                tile.addClass('selected');
                if (currentGameMarkers.length > 0) $(`#marker_area_${id}`).removeClass('d-none');
            } else {
                tile.removeClass('selected');
                $(`#marker_area_${id}`).addClass('d-none');
            }

            updateLockState();
        }

        function updateLockState() {
            const count = $('.p-check:checked').length;
            $('.player-tile').each(function () {
                const chk = $(this).find('.p-check');
                if (!chk.is(':checked')) {
                    if (count >= maxPlayers) $(this).addClass('locked');
                    else $(this).removeClass('locked');
                }
            });
        }

        function openMarkerModal(pid) {
            activePlayerId = pid;
            const grid = $('#modalMarkerGrid').empty();

            const assigned = $('.player-marker-value').map(function () {
                return $(this).data('pid') != pid ? $(this).val() : null;
            }).get();

            currentGameMarkers.forEach(m => {
                const taken = assigned.includes(m.id.toString());
                const item = $(`
                    <div class="marker-option ${taken ? 'disabled' : ''}" onclick="${taken ? '' : `selectMarker(${m.id}, '${(m.name || '').replace(/'/g, "\\'")}', '${m.imageUrl || ''}')`}">
                        ${m.imageUrl ? `<img src="${m.imageUrl}" loading="lazy" decoding="async" style="width:40px;height:40px;object-fit:contain;"/>` : '<div style="height:40px;"></div>'}
                        <div class="small fw-bold">${m.name} ${taken ? '<br>(Taken)' : ''}</div>
                    </div>
                `);
                grid.append(item);
            });

            new bootstrap.Modal('#markerModal').show();
        }

        function selectMarker(mid, name, imgUrl) {
            $(`.player-marker-value[data-pid="${activePlayerId}"]`).val(mid);

            const badge = $(`#selected_role_${activePlayerId}`);
            badge.find('.role-text').text(name);

            if (imgUrl) badge.find('.marker-search-img').attr('src', imgUrl).removeClass('d-none');
            else badge.find('.marker-search-img').addClass('d-none');

            badge.removeClass('d-none');
            bootstrap.Modal.getInstance('#markerModal').hide();
        }

        function clearMarker(pid) {
            $(`#selected_role_${pid}`).addClass('d-none');
            $(`.player-marker-value[data-pid="${pid}"]`).val('');
        }

        $('#matchForm').submit(function () {
            const data = [];
            $('.p-check:checked').each(function () {
                const pid = $(this).val();
                const mid = $(`.player-marker-value[data-pid="${pid}"]`).val();
                data.push({ PlayerId: parseInt(pid), MarkerId: mid ? parseInt(mid) : null });
            });
            $('#markersJson').val(JSON.stringify(data));
            return true;
        });

                function getInitials(fullName) {
            if (!fullName) return "?";
            const parts = fullName.trim().split(/\s+/).filter(Boolean);
            if (parts.length === 0) return "?";
            const first = parts[0][0] || "";
            const last = parts.length > 1 ? (parts[parts.length - 1][0] || "") : "";
            return (first + last).toUpperCase();
        }

        function colourFromString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const hue = Math.abs(hash) % 360;
            return `hsl(${hue}, 65%, 45%)`;
        }

        function makeInitialsAvatar(imgEl, fullName) {
            imgEl.onerror = null;

            const initials = getInitials(fullName);
            const bg = colourFromString(fullName || initials);

            const badge = document.createElement('div');
            badge.className = (imgEl.className || '') + ' initials-avatar';
            badge.textContent = initials;
            badge.style.background = bg;

            badge.style.marginRight = "1rem";

            imgEl.replaceWith(badge);
        }

    </script>
}
