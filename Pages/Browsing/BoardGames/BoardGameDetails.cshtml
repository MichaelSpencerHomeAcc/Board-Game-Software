@page "{id:long}"
@model Board_Game_Software.Pages.Browsing.BoardGames.BoardGameDetailsModel
@inject Microsoft.AspNetCore.Identity.UserManager<Microsoft.AspNetCore.Identity.IdentityUser> UserManager
@inject Microsoft.AspNetCore.Identity.SignInManager<Microsoft.AspNetCore.Identity.IdentityUser> SignInManager

@{
    ViewData["Title"] = Model.BoardGame?.BoardGameName ?? "Board Game Details";
    var isAdmin = false;
    if (SignInManager.IsSignedIn(User))
    {
        var currentUser = await UserManager.GetUserAsync(User);
        isAdmin = currentUser != null && await UserManager.IsInRoleAsync(currentUser, "Admin");
    }
    var shelfName = Model.BoardGame?.BoardGameShelfSections?.FirstOrDefault()?.FkBgdShelfSectionNavigation?.SectionName;
}

<style>
    .avatar-container {
        width: 160px;
        height: 160px;
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 4px solid white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        background-color: var(--bs-tertiary-bg);
    }

        .avatar-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .avatar-large-text {
        color: white;
        font-weight: 600;
        font-size: 3rem;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .detail-label {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--bs-secondary);
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .avg-rating-display {
        font-size: 3.5rem;
        font-weight: 800;
        color: #ffc107;
        line-height: 1;
    }

    .star-rating-container {
        display: flex;
        justify-content: center;
        gap: 4px;
    }

    .btn-star {
        background: none;
        border: none;
        padding: 0;
        font-size: 2.25rem;
        color: var(--bs-border-color);
        transition: transform 0.1s, color 0.1s;
        cursor: pointer;
    }

        .btn-star:hover {
            transform: scale(1.15);
        }

        .btn-star.active {
            color: #ffc107;
        }

    .scrolling-wrapper {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        padding-bottom: 1rem;
        gap: 1rem;
    }

    .component-card {
        flex: 0 0 auto;
        width: 140px;
        border: 1px solid var(--bs-border-color);
        text-decoration: none;
        transition: transform 0.2s;
    }

        .component-card:hover {
            transform: translateY(-4px);
            border-color: var(--bs-primary);
        }

    .component-card-img {
        height: 90px;
        background: var(--bs-tertiary-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

        .component-card-img img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 5px;
        }
</style>

<div class="container py-4">
    @if (Model.BoardGame != null)
    {
        <div class="card border-0 shadow-sm mb-4 overflow-hidden">
            <div class="card-body p-4 p-md-5 bg-body-tertiary d-flex flex-column flex-md-row align-items-center">
                <div class="me-md-5 mb-3 mb-md-0">
                    <div class="avatar-container">
                        @if (!string.IsNullOrEmpty(Model.BoardGameFrontImageUrl))
                        {
                            <img src="@Model.BoardGameFrontImageUrl" alt="Cover" />
                        }
                        else
                        {
                            <div class="avatar-large-text" style="background-color: @Model.GetAvatarColor(Model.BoardGame.BoardGameName);">
                                @Model.GetInitials(Model.BoardGame.BoardGameName)
                            </div>
                        }
                    </div>
                </div>
                <div class="text-center text-md-start">
                    <h1 class="display-5 fw-bold mb-1">@Model.BoardGame.BoardGameName</h1>
                    <div class="d-flex gap-2 justify-content-center justify-content-md-start">
                        <span class="badge bg-secondary-subtle text-secondary border rounded-pill">@(Model.BoardGame.ReleaseDate?.Year)</span>
                        @if (!string.IsNullOrEmpty(shelfName))
                        {
                            <span class="badge bg-primary-subtle text-primary border rounded-pill"><i class="bi bi-bookshelf me-1"></i> @shelfName</span>
                        }
                    </div>
                </div>
                <div class="ms-md-auto mt-4 mt-md-0 d-flex gap-2">
                    @if (isAdmin)
                    {
                        <a asp-page="/Browsing/BoardGames/Edit" asp-route-id="@Model.BoardGame.Id" class="btn btn-primary px-4">Edit Game</a>
                    }
                    <a asp-page="./Index" class="btn btn-outline-secondary">Back</a>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-lg-8">
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3">
                        <div class="card border-0 shadow-sm text-center p-3 h-100">
                            <i class="bi bi-people text-primary fs-3 mb-1"></i>
                            <div class="detail-label">Players</div>
                            <div class="fw-bold">@Model.BoardGame.PlayerCountMin@((Model.BoardGame.PlayerCountMax != Model.BoardGame.PlayerCountMin) ? "-" + Model.BoardGame.PlayerCountMax : "")</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-0 shadow-sm text-center p-3 h-100">
                            <i class="bi bi-clock text-primary fs-3 mb-1"></i>
                            <div class="detail-label">Time</div>
                            <div class="fw-bold">@Model.BoardGame.PlayingTimeMinInMinutes</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-0 shadow-sm text-center p-3 h-100">
                            <i class="bi bi-diagram-3 text-primary fs-3 mb-1"></i>
                            <div class="detail-label">Weight</div>
                            <div class="fw-bold">@Model.BoardGame.ComplexityRating?.ToString("0.0") / 5</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-0 shadow-sm text-center p-3 h-100">
                            <i class="bi bi-trophy text-primary fs-3 mb-1"></i>
                            <div class="detail-label">Victory</div>
                            <div class="fw-bold text-truncate small">@(Model.BoardGame.FkBgdBoardGameVictoryConditionTypeNavigation?.TypeDesc ?? "-")</div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm p-4 h-100">
                    <h5>About the Game</h5>
                    <p class="text-secondary lh-lg mb-4" style="white-space: pre-line;">@Model.BoardGame.BoardGameSummary</p>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-sm mb-4 text-center p-4">
                    <div class="detail-label">Community Rating</div>
                    <div class="avg-rating-display mb-1">@Model.AverageRating.ToString("0.0")</div>
                    <div class="mb-3">
                        @for (int i = 1; i <= 5; i++)
                        {
                            if (Model.AverageRating >= i)
                            {
                                <i class="bi bi-star-fill text-warning fs-5"></i>
                            }
                            else if (Model.AverageRating >= (i - 0.5m))
                            {
                                <i class="bi bi-star-half text-warning fs-5"></i>
                            }
                            else
                            {
                                <i class="bi bi-star text-warning fs-5"></i>
                            }
                        }
                    </div>
                    <div class="small text-muted mb-4">Based on @Model.TotalRatings ratings</div>
                    <hr class="mb-4" />
                    @if (SignInManager.IsSignedIn(User))
                    {
                        if (Model.CurrentUserClaimedPlayerId.HasValue)
                        {
                            <div class="detail-label mb-2">Rate this Game</div>
                            <div class="star-rating-container" id="userStarContainer">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    <form method="post" asp-page-handler="Rate" asp-route-id="@Model.BoardGame.Id" asp-route-ratingValue="@i" class="d-inline">
                                        <button type="submit" class="btn-star @(Model.UserRating >= (decimal)i ? "active" : "")" data-value="@i">
                                            <i class="bi @(Model.UserRating >= (decimal)i ? "bi-star-fill" : "bi-star")"></i>
                                        </button>
                                    </form>
                                }
                            </div>
                        }
                    }
                </div>

                <div class="card border-0 shadow-sm p-4">
                    <h5>Specifications</h5>
                    <div class="mt-3">
                        <div class="detail-label">Dimensions</div>
                        <div class="fw-bold">@Model.BoardGame.HeightCm x @Model.BoardGame.WidthCm cm</div>
                    </div>

                    <div class="mt-3">
                        <div class="detail-label text-primary fw-bold">Ranking Algorithm</div>
                        <div class="fw-bold"><i class="bi bi-cpu me-1"></i> @(Model.EloMethodName ?? "None (Casual)")</div>

                        @if (Model.EloMethodName != null)
                        {
                            <div class="mt-2">
                                <a asp-page="/Browsing/BoardGames/EloRankings"
                                   asp-route-id="@Model.BoardGame.Id"
                                   class="btn btn-sm btn-outline-primary w-100">
                                    <i class="bi bi-trophy me-1"></i> View Player Leaderboard
                                </a>
                            </div>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(Model.BoardGame.HowToPlayHyperlink))
                    {
                        <a href="@Model.BoardGame.HowToPlayHyperlink" target="_blank" class="btn btn-outline-danger w-100 mt-4">
                            <i class="bi bi-youtube me-2"></i>How to Play
                        </a>
                    }
                </div>
            </div>
        </div>

        <h4 class="mb-3">Box Components <span class="badge bg-secondary rounded-pill">@Model.BoardGame.BoardGameMarkers.Count</span></h4>
        <div class="scrolling-wrapper">
            @foreach (var marker in Model.BoardGame.BoardGameMarkers.OrderBy(m => m.FkBgdBoardGameMarkerTypeNavigation?.TypeDesc))
            {
                var mType = marker.FkBgdBoardGameMarkerTypeNavigation;
                var mImg = (mType != null && Model.MarkerImagesBase64.ContainsKey(mType.Id)) ? Model.MarkerImagesBase64[mType.Id] : null;
                <a asp-page="/DataSetup/Markers/Details" asp-route-id="@mType?.Id" class="card component-card shadow-sm rounded-3 overflow-hidden">
                    <div class="component-card-img">
                        @if (!string.IsNullOrEmpty(mImg))
                        {
                            <img src="@mImg" alt="Marker" />
                        }
                        else
                        {
                            <div class="w-100 h-100 d-flex align-items-center justify-content-center text-white fw-bold" style="background-color: @Model.GetAvatarColor(mType?.TypeDesc);">@Model.GetInitials(mType?.TypeDesc)</div>
                        }
                    </div>
                    <div class="card-body p-2 text-center text-truncate small fw-bold">@mType?.TypeDesc</div>
                </a>
            }
        </div>
    }
</div>