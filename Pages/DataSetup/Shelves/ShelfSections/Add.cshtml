@page
@model Board_Game_Software.Pages.DataSetup.Shelves.ShelfSections.AddModel
@{
    ViewData["Title"] = "New Shelf Section";
}

<style>
    .form-hero {
        background-color: var(--bs-tertiary-bg);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid var(--bs-border-color);
    }

    .form-card {
        background-color: var(--bs-body-bg);
        border-radius: 12px;
        border: 1px solid var(--bs-border-color);
    }

    .preview-grid {
        display: grid;
        grid-template-columns: repeat( @Model.MaxSections, 45px);
        gap: 6px;
        justify-content: center;
        background-color: var(--bs-secondary-bg);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--bs-border-color);
    }

    .preview-cubby {
        width: 45px;
        height: 45px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.6rem;
        border: 1px solid var(--bs-border-color);
        background-color: var(--bs-body-bg);
        transition: all 0.2s ease;
        cursor: pointer;
        color: var(--bs-body-color);
    }

    /* STATE: Existing Section */
    .cubby-exists {
        background-color: var(--bs-tertiary-bg);
        color: var(--bs-secondary-color);
        opacity: 0.5;
        cursor: not-allowed;
        border-style: solid;
    }

    /* STATE: The Selected Slot (The Fix for Fading) */
    .cubby-new {
        background-color: #198754 !important;
        color: white !important;
        border-color: #146c43 !important;
        border-style: solid !important;
        font-weight: bold;
        transform: scale(1.1);
        z-index: 2;
        opacity: 1 !important;
        box-shadow: 0 0 10px rgba(25, 135, 84, 0.5);
    }

    /* STATE: Available Empty Slot */
    .cubby-empty {
        border-style: dashed;
        opacity: 0.2;
        background-color: transparent;
    }

        .cubby-empty:hover {
            border-color: var(--bs-success);
            opacity: 0.8;
            border-style: solid;
        }

    .cubby-invalid-flash {
        border-color: var(--bs-danger) !important;
        background-color: rgba(220, 53, 69, 0.2) !important;
        opacity: 1 !important;
    }
</style>

<div class="container py-4">
    <div class="form-hero shadow-sm d-flex align-items-center mb-4">
        <div class="bg-success text-white rounded-3 p-3 me-3">
            <i class="bi bi-grid-3x3 h3 mb-0"></i>
        </div>
        <div>
            <h1 class="h4 fw-bold mb-1">Add Section</h1>
            <p class="text-muted mb-0 small">Shelf: <strong>@Model.Shelf.ShelfName</strong></p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-7">
            <div asp-validation-summary="All" class="text-danger mb-3 small fw-bold"></div>
            <div class="card form-card shadow-sm p-4">
                <form method="post">
                    <input type="hidden" asp-for="ShelfSection.FkBgdShelf" />
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold small text-uppercase text-muted">Section Name</label>
                            <input asp-for="ShelfSection.SectionName" id="sectionNameInput" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-uppercase text-muted">Row</label>
                            <input asp-for="ShelfSection.RowNumber" id="rowInput" class="form-control bg-dark-subtle" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-uppercase text-muted">Column</label>
                            <input asp-for="ShelfSection.SectionNumber" id="colInput" class="form-control bg-dark-subtle" readonly />
                        </div>
                        <div class="col-md-12">
                            <label class="form-label fw-bold small text-uppercase text-muted">Width (cm)</label>
                            <input asp-for="ShelfSection.WidthCm" class="form-control" type="number" step="0.1" />
                        </div>
                    </div>
                    <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                        <a href="/DataSetup/Shelves/Details/@Model.ShelfSection.FkBgdShelf" class="btn btn-outline-secondary px-4">Cancel</a>
                        <button type="submit" class="btn btn-success px-4">Create Section</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-5 text-center">
            <h6 class="fw-bold text-muted text-uppercase small mb-3">Click Grid to Place</h6>
            <div class="d-inline-block shadow-sm rounded p-2 bg-secondary-subtle">
                <div class="preview-grid" id="previewGrid">
                    @for (int r = 1; r <= Model.MaxRows; r++)
                    {
                        @for (int c = 1; c <= Model.MaxSections; c++)
                        {
                            var existing = Model.ExistingSections.FirstOrDefault(x => x.RowNumber == r && x.SectionNumber == c);
                            bool isNew = (Model.ShelfSection.RowNumber == r && Model.ShelfSection.SectionNumber == c);
                            <div class="preview-cubby @(isNew ? "cubby-new" : (existing != null ? "cubby-exists" : "cubby-empty"))"
                                 data-row="@r" data-col="@c" data-name="@(existing?.SectionName ?? "")">
                                @(isNew ? "NEW" : (existing != null ? existing.SectionName : ""))
                            </div>
                        }
                    }
                </div>
            </div>
            <p class="text-muted small mt-3 px-4">Select a slot adjacent to an existing section. Diagonal placements are not allowed.</p>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const rowInp = document.getElementById('rowInput');
        const colInp = document.getElementById('colInput');
        const nameInp = document.getElementById('sectionNameInput');
        const grid = document.getElementById('previewGrid');

        function updateUI() {
            const r = parseInt(rowInp.value);
            const c = parseInt(colInp.value);

            // --- SMART NAME SUGGESTION ---
            const leftNeighbor = document.querySelector(`.preview-cubby[data-row="${r}"][data-col="${c - 1}"]`);
            const topNeighbor = document.querySelector(`.preview-cubby[data-row="${r - 1}"][data-col="${c}"]`);

            if (leftNeighbor && leftNeighbor.dataset.name !== "") {
                // If there's a neighbor to the left, take its name and increment the number
                // e.g., "A1" -> "A2"
                const prevName = leftNeighbor.dataset.name;
                const match = prevName.match(/^([a-zA-Z]+)(\d+)$/);
                if (match) {
                    nameInp.value = match[1] + (parseInt(match[2]) + 1);
                }
            } else if (topNeighbor && topNeighbor.dataset.name !== "") {
                // If there's a neighbor above, take its name and increment the letter
                // e.g., "A1" -> "B1"
                const prevName = topNeighbor.dataset.name;
                const match = prevName.match(/^([a-zA-Z]+)(\d+)$/);
                if (match) {
                    const nextLetter = String.fromCharCode(match[1].charCodeAt(0) + 1);
                    nameInp.value = nextLetter + match[2];
                }
            } else if (!isNaN(r)) {
                // Fallback to default logic if no immediate neighbors
                nameInp.value = String.fromCharCode(64 + r) + (isNaN(c) ? "" : c);
            }

            // --- REFRESH GRID VISUALS ---
            document.querySelectorAll('.preview-cubby').forEach(el => {
                const cubbyRow = parseInt(el.dataset.row);
                const cubbyCol = parseInt(el.dataset.col);
                const originalName = el.dataset.name;

                el.classList.remove('cubby-new', 'cubby-empty', 'cubby-exists');

                if (cubbyRow === r && cubbyCol === c) {
                    el.classList.add('cubby-new');
                    el.innerText = "NEW";
                } else if (originalName !== "") {
                    el.classList.add('cubby-exists');
                    el.innerText = originalName;
                } else {
                    el.classList.add('cubby-empty');
                    el.innerText = "";
                }
            });
        }

        grid.addEventListener('click', (e) => {
            const cubby = e.target.closest('.preview-cubby');
            if (!cubby || cubby.dataset.name !== "") return;

            const newR = parseInt(cubby.dataset.row);
            const newC = parseInt(cubby.dataset.col);
            const existing = document.querySelectorAll('.cubby-exists');

            let isValid = existing.length === 0;

            existing.forEach(ex => {
                const exR = parseInt(ex.dataset.row);
                const exC = parseInt(ex.dataset.col);
                if ((Math.abs(newR - exR) === 1 && newC === exC) || (Math.abs(newC - exC) === 1 && newR === exR)) {
                    isValid = true;
                }
            });

            if (isValid) {
                rowInp.value = newR;
                colInp.value = newC;
                updateUI();
            } else {
                cubby.classList.add('cubby-invalid-flash');
                setTimeout(() => { cubby.classList.remove('cubby-invalid-flash'); }, 400);
            }
        });

        document.addEventListener('DOMContentLoaded', updateUI);
    </script>
}