@page
@model Board_Game_Software.Pages.Statistics.IndexModel
@{
    ViewData["Title"] = "Statistics";
}

@functions {
    public string GetInitials(string? fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName)) return "?";
        var parts = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);

        if (parts.Length == 1) return parts[0][0].ToString().ToUpper();
        if (parts.Length > 1) return (parts[0][0].ToString() + parts[parts.Length - 1][0].ToString()).ToUpper();
        return "?";
    }

    public string GetAvatarColor(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "#6c757d";
        int hash = 0;
        foreach (char c in name) { hash = c + ((hash << 5) - hash); }
        var colors = new[] { "#d32f2f", "#c2185b", "#7b1fa2", "#512da8", "#303f9f", "#1976d2", "#0288d1", "#0097a7", "#00796b", "#388e3c", "#689f38", "#fbc02d", "#ffa000", "#f57c00", "#e64a19", "#5d4037", "#616161", "#455a64" };
        return colors[Math.Abs(hash) % colors.Length];
    }
}

<style>
    /* PERSONNEL HUD */
    .personnel-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 2rem;
    }

    .player-avatar-large {
        width: 80px;
        height: 80px;
        border-radius: 12px;
        object-fit: cover;
        border: 2px solid #0dcaf0;
        box-shadow: 0 0 15px rgba(13, 202, 240, 0.3);
    }

    /* MINI AVATAR & INITIALS */
    .avatar-mini {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        border: 1px solid rgba(255,255,255,0.1);
        background-color: #1a1d21;
    }

        .avatar-mini img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .initials-text {
        color: white;
        font-weight: 700;
        font-size: 0.9rem;
        letter-spacing: -0.5px;
    }

    /* DIGITAL HUD SCORE BADGE */
    .digital-hud-badge {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-weight: 900;
        font-size: 1.1rem;
        color: #0dcaf0;
        background: rgba(13, 202, 240, 0.1);
        border: 1px solid rgba(13, 202, 240, 0.3);
        padding: 4px 12px;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(13, 202, 240, 0.1);
        display: inline-block;
        min-width: 90px;
        text-align: center;
    }

    /* REUSE EXISTING STAT WINDOW STYLES */
    .stat-window {
        position: relative;
        height: 160px;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.1);
        background-color: #1a1d21;
        transition: transform 0.2s ease-in-out;
    }

        .stat-window:hover {
            transform: translateY(-5px);
        }

    .window-bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.35;
        z-index: 1;
    }

    .window-overlay {
        position: relative;
        z-index: 2;
        padding: 1.25rem;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        background: linear-gradient(to right, rgba(0,0,0,0.85), transparent);
    }

    .rank-indicator {
        font-size: 3rem;
        font-weight: 900;
        line-height: 1;
        margin-bottom: 2px;
        background: linear-gradient(to bottom, #fff, #adb5bd);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    /* PODIUM GLOW (Top 3 global rank per game) */
    .stat-window.podium {
        border-width: 2px;
    }

    .stat-window.podium-gold {
        border-color: rgba(255, 215, 0, 0.65);
        box-shadow: 0 0 0 1px rgba(255, 215, 0, 0.25), 0 0 18px rgba(255, 215, 0, 0.35), 0 0 40px rgba(255, 215, 0, 0.18);
    }

    .stat-window.podium-silver {
        border-color: rgba(192, 192, 192, 0.65);
        box-shadow: 0 0 0 1px rgba(192, 192, 192, 0.25), 0 0 18px rgba(192, 192, 192, 0.30), 0 0 40px rgba(192, 192, 192, 0.15);
    }

    .stat-window.podium-bronze {
        border-color: rgba(205, 127, 50, 0.70);
        box-shadow: 0 0 0 1px rgba(205, 127, 50, 0.25), 0 0 18px rgba(205, 127, 50, 0.30), 0 0 40px rgba(205, 127, 50, 0.15);
    }
</style>

<div class="container-fluid py-4">
    <div class="personnel-header">
        @if (!string.IsNullOrEmpty(Model.PlayerProfileImage))
        {
            <img src="@Model.PlayerProfileImage" class="player-avatar-large" alt="Profile" />
        }
        <div class="flex-grow-1">
            <h1 class="stats-title text-body m-0">Statistics</h1>
            <p class="text-muted mb-0">Cross-reference player performance and global records.</p>
        </div>
    </div>

    @* --- FILTER HUD --- *@
    <div class="mb-5">
        <form method="get">
            <div class="input-group shadow-sm border border-secondary border-opacity-25 rounded-3 overflow-hidden">
                <span class="input-group-text bg-body border-0 text-muted"><i class="bi bi-search"></i></span>
                <select asp-for="SelectedPlayerId" asp-items="Model.PlayerList" class="form-select border-0 bg-body">
                    <option value="">Select Personnel Profile...</option>
                </select>
                <select asp-for="SelectedYear" asp-items="Model.YearList" class="form-select border-0 bg-body">
                    <option value="">Year</option>
                </select>
                <select asp-for="SelectedMonth" asp-items="Model.MonthList" class="form-select border-0 bg-body">
                    <option value="">Month</option>
                </select>
                <button class="btn btn-primary px-4 fw-bold" type="submit">Execute Query</button>
            </div>
        </form>
    </div>

    @* --- PERSONNEL WINDOWS --- *@
    @if (Model.SelectedPlayerId.HasValue && Model.PersonalBests.Any())
    {
        <div class="row row-cols-1 row-cols-md-3 row-cols-xl-4 g-4 mb-5">
            @foreach (var best in Model.PersonalBests)
            {
                var podiumClass =
                best.Rank == 1 ? "podium podium-gold" :
                best.Rank == 2 ? "podium podium-silver" :
                best.Rank == 3 ? "podium podium-bronze" :
                "";

                <div class="col">
                    <div class="stat-window @podiumClass">
                        @if (!string.IsNullOrEmpty(best.Base64Image))
                        {
                            <img src="@best.Base64Image" class="window-bg" alt="" />
                        }
                        <div class="window-overlay">
                            <div>
                                <div class="rank-indicator">#@best.Rank</div>
                                <div class="rank-label text-info">Global Rank</div>
                            </div>
                            <div>
                                <span class="game-name-large">@best.GameName.ToUpper()</span>
                                <div class="score-label fw-bold">@best.Score.ToString("N0") PTS</div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    @* --- GLOBAL RECORDS TABLE --- *@
    <div class="card shadow-sm border-0 bg-transparent mt-4">
        <div class="card-header bg-transparent border-0 ps-0 mb-2">
            <h5 class="fw-bold m-0 text-uppercase tracking-widest small text-muted">Global High Scores</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="border-bottom border-secondary-subtle">
                    <tr>
                        <th class="ps-4" style="width: 45%;">Game Module</th>
                        <th style="width: 25%;">Record Holder</th>
                        <th class="text-center" style="width: 15%;">High Score</th>
                        <th class="text-end pe-4" style="width: 15%;">Timestamp</th>
                    </tr>
                </thead>
                <tbody class="border-0">
                    @foreach (var record in Model.GlobalRecords)
                    {
                        <tr>
                            <td class="ps-4 border-0">
                                <span class="fw-bold text-body-emphasis">@record.GameName</span>
                            </td>
                            <td class="border-0">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-mini me-2 shadow-sm">
                                        @if (!string.IsNullOrEmpty(record.PlayerBase64Image))
                                        {
                                            <img src="@record.PlayerBase64Image"
                                                 style="object-position: @(record.AvatarFocusX)% @(record.AvatarFocusY)%; transform: scale(@(record.AvatarZoom / 100.0));" />
                                        }
                                        else
                                        {
                                            <div class="initials-text h-100 w-100 d-flex align-items-center justify-content-center"
                                                 style="background-color: @GetAvatarColor(record.PlayerName);">
                                                @GetInitials(record.PlayerName)
                                            </div>
                                        }
                                    </div>
                                    <span class="fw-semibold">@record.PlayerName</span>
                                </div>
                            </td>
                            <td class="text-center border-0">
                                <span class="digital-hud-badge">
                                    @record.Score.ToString("N0")
                                </span>
                            </td>
                            <td class="text-end pe-4 border-0 text-muted small">@record.Date.ToString("yyyy-MM")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
