@page
@using System.Security.Claims
@using System.Text.Encodings.Web
@model Board_Game_Software.Pages.DataSetup.Players.IndexModel
@{
    ViewData["Title"] = "Players";
    var isAdmin = User.IsInRole("Admin");
    var currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
}

<style>
    .fixed-table {
        table-layout: fixed;
        width: 100%;
        border-collapse: collapse;
    }

        .fixed-table tbody tr {
            height: 92px !important;
        }

        .fixed-table td {
            height: 92px !important;
            padding: 0 12px !important;
            vertical-align: middle;
            overflow: hidden;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

    .img-lockdown {
        width: 64px !important;
        height: 64px !important;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border-radius: 50%;
        flex-shrink: 0;
        background-color: var(--bs-tertiary-bg);
        border: 1px solid rgba(0,0,0,0.1);
        transition: transform 0.2s ease-in-out;
    }

        .img-lockdown img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .avatar-text {
        color: white;
        font-weight: 600;
        font-size: 1.5rem;
        letter-spacing: -1px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .clickable-row:hover {
        background-color: rgba(var(--bs-primary-rgb), 0.06) !important;
    }

        .clickable-row:hover .img-lockdown {
            transform: scale(1.05);
        }

    .text-truncate-custom {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="text-body m-0">Players</h1>
            <p class="text-muted mb-0">Registered personnel profiles.</p>
        </div>
        @if (isAdmin)
        {
            <a asp-page="Add" class="btn btn-primary shadow-sm">
                <i class="bi bi-plus-circle me-1"></i> Add New Player
            </a>
        }
    </div>

    <div class="mb-4">
        <form method="get" autocomplete="off">
            <div class="input-group shadow-sm">
                <span class="input-group-text bg-body border-end-0 text-muted"><i class="bi bi-search"></i></span>
                <input name="search"
                       class="form-control border-start-0 ps-0"
                       placeholder="Search players..."
                       value="@Model.SearchTerm" />
                <button class="btn btn-primary px-4" type="submit">Search</button>
            </div>
        </form>
    </div>

    <div class="card shadow-sm border-0 bg-transparent">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 fixed-table">
                <thead class="border-bottom border-secondary-subtle">
                    <tr>
                        <th class="ps-4" style="width: 50%;">Player Name</th>
                        <th style="width: 35%;">Date of Birth</th>
                        <th class="text-end pe-4" style="width: 15%;">Actions</th>
                    </tr>
                </thead>

                <tbody class="border-0">
                    @foreach (var item in Model.Players)
                    {
                        var canEdit = isAdmin || (item.FKdboAspNetUsers == currentUserId);
                        var safeName = JavaScriptEncoder.Default.Encode(item.FullName);

                        <tr class="clickable-row border-bottom border-secondary-subtle"
                            data-href="@Url.Page("./Details", new { id = item.Id })"
                            style="cursor: pointer;">

                            <td class="ps-4 border-0">
                                <div class="d-flex align-items-center">
                                    <div class="img-lockdown me-3 shadow-sm">
                                        <img src="@item.AvatarUrl"
                                             alt="@item.FullName"
                                             width="64" height="64"
                                             loading="lazy" decoding="async"
                                             style="object-position:@item.FocusStyle;"
                                             onerror="makeInitialsAvatar(this, '@safeName')" />
                                    </div>

                                    <span class="fw-bold text-body-emphasis text-truncate-custom">@item.FullName</span>
                                </div>
                            </td>

                            <td class="border-0">
                                <span class="text-body-secondary">
                                    @(item.DateOfBirth.HasValue? item.DateOfBirth.Value.ToString("d") : "-")
                                </span>
                            </td>

                            <td class="text-end pe-4 border-0">
                                <div class="btn-group shadow-sm">
                                    <a asp-page="./Details" asp-route-id="@item.Id" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-eye"></i>
                                    </a>

                                    @if (canEdit)
                                    {
                                        <a asp-page="./Edit" asp-route-id="@item.Id"
                                           class="btn btn-sm btn-outline-primary"
                                           style="@(!isAdmin ? "border-top-right-radius: 0.375rem; border-bottom-right-radius: 0.375rem;" : "")">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                    }

                                    @if (isAdmin)
                                    {
                                        <form method="post"
                                              asp-page-handler="Delete"
                                              asp-route-id="@item.Id"
                                              class="d-inline"
                                              onsubmit="return confirm('Delete this profile?');">
                                            <button type="submit"
                                                    class="btn btn-sm btn-outline-danger"
                                                    style="border-top-left-radius: 0; border-bottom-left-radius: 0;">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>

            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.clickable-row').forEach(row => {
                row.addEventListener('click', (e) => {
                    if (e.target.closest('button') || e.target.closest('a') || e.target.closest('form')) return;
                    window.location.href = row.getAttribute('data-href');
                });
            });
        });

        function getInitials(fullName) {
            if (!fullName) return "?";
            const parts = fullName.trim().split(/\s+/).filter(Boolean);
            const first = parts[0]?.[0] || "";
            const last = parts.length > 1 ? (parts[parts.length - 1]?.[0] || "") : "";
            return (first + last).toUpperCase();
        }

        function colourFromString(str) {
            if (!str) return "#6c757d";
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const colours = ["#d32f2f","#c2185b","#7b1fa2","#512da8","#303f9f","#1976d2","#0288d1","#0097a7","#00796b","#388e3c","#689f38","#fbc02d","#ffa000","#f57c00","#e64a19","#5d4037","#616161","#455a64"];
            return colours[Math.abs(hash) % colours.length];
        }

        function makeInitialsAvatar(imgEl, fullName) {
            imgEl.onerror = null;

            const initials = getInitials(fullName);
            const bg = colourFromString(fullName || initials);

            const div = document.createElement('div');
            div.className = 'avatar-text';
            div.style.backgroundColor = bg;
            div.textContent = initials;

            imgEl.replaceWith(div);
        }
    </script>
}
