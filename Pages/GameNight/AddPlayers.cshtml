@page
@model Board_Game_Software.Pages.GameNight.AddPlayersModel
@{
    ViewData["Title"] = "Add Players";

    string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1) return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpperInvariant();
        return (parts[0][0].ToString() + parts[^1][0].ToString()).ToUpperInvariant();
    }

    string GetAvatarColor(string name)
    {
        if (string.IsNullOrEmpty(name)) return "#6c757d";
        int hash = name.GetHashCode();
        var colors = new[] { "#d32f2f", "#c2185b", "#7b1fa2", "#512da8", "#303f9f", "#1976d2", "#0288d1", "#0097a7", "#00796b", "#388e3c", "#689f38", "#fbc02d", "#ffa000", "#f57c00", "#e64a19", "#5d4037", "#616161", "#455a64" };
        return colors[Math.Abs(hash) % colors.Length];
    }
}

<style>
    .card-custom {
        background-color: transparent;
        border: none;
    }

    .player-tile {
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(var(--bs-tertiary-bg-rgb), 0.5);
        border-radius: 12px;
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        user-select: none;
    }

        .player-tile:hover {
            background: rgba(var(--bs-primary-rgb), 0.08);
            border-color: rgba(var(--bs-primary-rgb), 0.3);
            transform: translateY(-2px);
        }

    .player-checkbox:checked + .player-tile {
        background: rgba(var(--bs-primary-rgb), 0.15);
        border-color: var(--bs-primary);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

        .player-checkbox:checked + .player-tile .check-indicator {
            opacity: 1 !important;
        }

    .avatar-circle {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        flex-shrink: 0;
        overflow: hidden;
        border: 2px solid rgba(255,255,255,0.1);
    }

        .avatar-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .sticky-bottom-bar {
        position: sticky;
        bottom: 0;
        background: var(--bs-body-bg);
        border-top: 1px solid rgba(255,255,255,0.1);
        padding: 1rem 0;
        z-index: 1020;
        margin-top: 2rem;
    }

    .search-input-group {
        max-width: 400px;
    }

    .muted-divider {
        border-top: 1px dashed rgba(255,255,255,0.15);
    }

    .check-indicator {
        transition: opacity 0.2s;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="text-body m-0">Add Players</h1>
            <p class="text-muted mb-0">Invite more attendees to this session.</p>
        </div>
    </div>

    <form method="post" autocomplete="off">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <input type="hidden" asp-for="Input.NightId" />
        <input type="hidden" asp-for="Input.ReturnUrl" />

        <div class="card card-custom">
            <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-3">
                <h5 class="m-0 fw-bold">Select Players</h5>
                <div class="d-flex align-items-center gap-2 flex-grow-1 justify-content-md-end">
                    <div class="input-group input-group-sm search-input-group shadow-sm">
                        <span class="input-group-text bg-body border-end-0 text-muted">
                            <i class="bi bi-search"></i>
                        </span>
                        <input id="playerSearch" type="search" class="form-control border-start-0 ps-0" placeholder="Search players... (press /)" />
                    </div>
                    <button id="btnSelectAll" type="button" class="btn btn-sm btn-outline-secondary">Select All</button>
                    <button id="btnClearAll" type="button" class="btn btn-sm btn-outline-secondary">Clear</button>
                </div>
            </div>

            <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 row-cols-xxl-4 g-3" id="playersGrid">
                @foreach (var p in Model.AllPlayers)
                {
                    <div class="col player-item" data-name="@p.Name.ToLowerInvariant()">
                        <input class="d-none player-checkbox" type="checkbox" id="player_@p.PlayerId"
                               name="Input.SelectedPlayerIds" value="@p.PlayerId" @(p.Preselected ? "checked" : null) />

                        <label for="player_@p.PlayerId" class="player-tile w-100 h-100 shadow-sm">
                            <div class="avatar-circle" style="background-color: @(string.IsNullOrEmpty(p.AvatarBase64) ? GetAvatarColor(p.Name) : "transparent");">
                                @if (!string.IsNullOrEmpty(p.AvatarBase64))
                                {
                                    <img src="@p.AvatarBase64" alt="@p.Name" />
                                }
                                else
                                {
                                    @GetInitials(p.Name)
                                }
                            </div>
                            <div class="flex-grow-1 overflow-hidden">
                                <div class="fw-bold text-truncate text-body">@p.Name</div>
                                <div class="text-muted small">Available Player</div>
                            </div>
                            <div class="check-indicator text-primary opacity-0">
                                <i class="bi bi-check-circle-fill fs-5"></i>
                            </div>
                        </label>
                    </div>
                }
            </div>

            <div class="mt-4 pt-3 muted-divider d-flex align-items-center justify-content-between">
                <div class="text-muted small">
                    <span class="badge bg-primary rounded-pill me-1" id="selectedCount">0</span> selected to add
                </div>
                <div class="d-none d-md-block text-muted small opacity-50">
                    <kbd>/</kbd> search • <kbd>A</kbd> select all • <kbd>C</kbd> clear
                </div>
            </div>
        </div>

        <div class="sticky-bottom-bar">
            <div class="d-flex justify-content-end gap-2">
                <a class="btn btn-outline-secondary px-4"
                   href="@(Model.Input.ReturnUrl ?? Url.Page("/GameNight/Details", new { id = Model.Input.NightId }))">Cancel</a>
                <button type="submit" class="btn btn-primary px-5 shadow">
                    <i class="bi bi-person-plus-fill me-1"></i> Add Selected
                </button>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
          const grid = document.getElementById('playersGrid');
          const search = document.getElementById('playerSearch');
          const selectAll = document.getElementById('btnSelectAll');
          const clearAll = document.getElementById('btnClearAll');
          const countEl = document.getElementById('selectedCount');

          function visibleItems() {
            return Array.from(grid?.querySelectorAll('.player-item') || []).filter(it => it.style.display !== 'none');
          }
          function updateCount() {
            const n = document.querySelectorAll('.player-checkbox:checked').length;
            if (countEl) countEl.textContent = n.toString();
          }
          function filter() {
            const term = (search?.value || '').trim().toLowerCase();
            (grid?.querySelectorAll('.player-item') || []).forEach(it => {
              const name = it.getAttribute('data-name') || '';
              it.style.display = (!term || name.includes(term)) ? '' : 'none';
            });
          }

          search?.addEventListener('input', filter);
          selectAll?.addEventListener('click', () => { visibleItems().forEach(it => it.querySelector('.player-checkbox').checked = true); updateCount(); });
          clearAll?.addEventListener('click', () => { visibleItems().forEach(it => it.querySelector('.player-checkbox').checked = false); updateCount(); });
          document.addEventListener('change', (e) => { if (e.target.classList.contains('player-checkbox')) updateCount(); });
          document.addEventListener('keydown', (e) => {
            if (e.key === '/' && document.activeElement !== search) { e.preventDefault(); search?.focus(); }
            if (document.activeElement !== search) {
                if (e.key.toLowerCase() === 'a') { e.preventDefault(); selectAll?.click(); }
                if (e.key.toLowerCase() === 'c') { e.preventDefault(); clearAll?.click(); }
            }
          });
          filter(); updateCount();
        })();
    </script>
}